# TCP 연결 및 종료 과정(3-way / 4-way handshake)


## TCP 3-way Handshake (연결 설정)

TCP는 **신뢰성 있는 연결**을 맺기 위해 연결 전에 **3단계(handshake)** 를 수행한다.

### 흐름도

```
[Client]                          [Server]

   | ----------- SYN ------------> |   (1단계: 연결 요청)
   | <-------- SYN + ACK --------- |   (2단계: 요청 수락 + 응답)
   | ----------- ACK ------------> |   (3단계: 응답 확인)
```

### 단계별 설명

1. **SYN**
- 클라이언트가 서버에 연결을 요청하는 패킷을 전송한다.
- 이때 TCP 헤더의 `SYN` 플래그가 1로 설정된다.
- 클라이언트는 **초기 순서 번호(ISN)** 를 무작위로 설정 (시퀀스 번호 예측 공격 방지).
- 예시: `Client → Server : SYN (ISN=1000)`

2. **SYN + ACK**
- 서버가 요청을 수락하고 응답한다.
- 서버도 자신의 ISN을 설정하여 전송하며, 클라이언트 ISN + 1을 ACK로 보낸다.
- 예시: `Server → Client : SYN-ACK (ISN=2000, ACK=1001)`

3. **ACK**
- 클라이언트가 서버의 응답을 확인하고 최종 ACK를 보낸다.
- 예시: `Client → Server : ACK (ACK=2001)`

### 연결 상태 변화

- 클라이언트: `CLOSED → SYN_SENT → ESTABLISHED`
- 서버: `LISTEN → SYN_RECEIVED → ESTABLISHED`

### 타임아웃 및 재전송

- 각 단계에서 일정 시간 내에 응답이 없으면 패킷을 재전송한다.
- 여러 번 시도 후에도 응답이 없을 경우 연결 시도를 포기한다.

---

## TCP 4-way Handshake (연결 종료)

TCP 연결은 **양방향으로 종료**되어야 하므로 4단계의 핸드셰이크가 필요하다.

### 흐름도

```
[Client]                             [Server]

   | ----------- FIN ------------> |   (1단계: 연결 종료 요청)
   | <----------- ACK ------------ |   (2단계: 종료 요청 확인)
   | <----------- FIN ------------ |   (3단계: 서버도 종료 요청)
   | ----------- ACK ------------> |   (4단계: 종료 응답)
```

### 단계별 설명

1. **FIN**
- 클라이언트가 데이터 전송을 종료하고자 할 때 `FIN` 패킷을 전송
- 예시: `Client → Server : FIN`

2. **ACK**
- 서버는 `FIN` 패킷을 수신하고, 확인 응답 `ACK` 전송
- 예시: `Server → Client : ACK`

3. **FIN**
- 서버도 데이터 전송을 마쳤다면 `FIN` 패킷을 전송
- 예시: `Server → Client : FIN`

4. **ACK**
- 클라이언트는 서버의 FIN을 확인하고 ACK로 응답
- 예시: `Client → Server : ACK`

---

### 연결 상태 변화

- 클라이언트: `ESTABLISHED → FIN_WAIT_1 → FIN_WAIT_2 → TIME_WAIT → CLOSED`
- 서버: `ESTABLISHED → CLOSE_WAIT → LAST_ACK → CLOSED`

### TIME_WAIT 상태란?

- 클라이언트는 종료 후 일정 시간 동안 `TIME_WAIT` 상태에 머문다.
- 이는 지연된 패킷이 새로운 연결에 영향을 주지 않게 하고, 마지막 ACK가 유실된 경우 서버의 재전송 FIN에 응답하기 위함이다.
- 일반적으로 `2 * MSL (Maximum Segment Lifetime)` 동안 유지된다. (보통 30초~2분)

---

## 동시 종료 (Simultaneous Close)

- 클라이언트와 서버가 **동시에 FIN을 전송**하는 경우
- 서로 FIN을 받고 ACK를 보내는 과정이 병렬로 수행되며, 상태 전이는 다소 다르게 진행된다.

---

## Half-Close 상태

- 클라이언트가 FIN을 보내고 서버가 ACK만 보낸 상태에서는, 서버는 클라이언트로부터 데이터를 받지 않지만 여전히 데이터를 **전송할 수 있다**.
- 이는 클라이언트가 전송을 중단하더라도, 서버의 응답을 모두 받아야 할 때 유용하다.



---

## 기타 TCP 연결 관련 이슈

### 1. SYN Flooding 공격

- 공격자가 다량의 SYN 패킷을 보내 서버의 `SYN queue`(백로그 큐)를 가득 채워
  정상적인 클라이언트의 연결 요청을 거부하게 만드는 **DoS 공격**의 일종입니다.

### 2. TCP Fast Open

- TCP의 확장 기능으로, **반복적인 연결**에서는 3-way handshake 지연을 줄이고
  **SYN 패킷에 데이터를 실어 전송**할 수 있게 하여 RTT를 감소시킵니다.

### 3. RST (Reset) 패킷

- 비정상적인 상황이나 예외 상황에서 TCP 연결을 **즉시 종료**시키기 위해 사용됩니다.
- 예: 존재하지 않는 포트에 접근 시 서버가 RST로 응답

### 4. Keep-Alive 메커니즘

- 장시간 유휴 상태인 연결이 여전히 유효한지 확인하기 위해
  일정 주기로 **소량의 패킷을 주고받는 기능**이다.
- OS 및 설정에 따라 활성화 여부가 달라진다.

---

## 요약

- TCP 연결은 **3-way handshake**, 종료는 **4-way handshake**로 구성된다.
- 연결 및 종료 과정에서 **상태 변화, 타임아웃, 보안 이슈**까지 고려해야 힌다.
- Half-Close, Simultaneous FIN, TIME_WAIT 등은 **고급 동작의 이해**에 도움이 됨


